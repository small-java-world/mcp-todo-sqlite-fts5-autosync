# 改善仕様のまとめ

## 1. Meta セクション構造化
- `Meta:` 直後に JSON/YAML コードフェンスを置き、構造化メタを記述する。
- 例:
  ```markdown
  Meta:
  ```json
  {
    "priority": "High",
    "tags": ["release", "urgent"],
    "subtasks": [
      { "id": "T-123-a", "title": "Design review", "done": false },
      { "id": "T-123-b", "title": "QA confirmation", "done": false }
    ]
  }
  ```
  ```
- `importTodoMd` でパース→`upsertTask(..., meta)` に渡し、`exportTodoMd` は `JSON.stringify(meta, null, 2)` で出力。
- `meta` は JSON オブジェクト/`null`/`undefined` を許容し、バリデーションと警告ロギングを実施。

## 2. Timeline ブロック
- `Timeline:` 行の直後を Markdown リストで時系列イベントを記録。
  - 例: `- 2025-02-12T08:03:12Z | STATE CHANGES_REQUESTED by reviewerA note "Needs fixes"`
- イベントタイプ: `STATE`, `REVIEW`, `COMMENT`, `ARCHIVE`, `RESTORE` など。
- `exportTodoMd` で履歴テーブル（`task_state_history`, `reviews`, `review_comments`, `archived_tasks`）から生成。
- `importTodoMd` はブロックを解析し、未登録イベントのみ DB に反映。`setState`/`addReview` 等を再利用。

## 3. Related ブロックの標準化
- `Related:` を単行 `[T-123]` 列挙、または箇条書きで `[T-123|blocks]` のように関係種別を明示。
- `task_links` テーブル（`task_id`, `target_id`, `relation`, `created_at`, `note`）を追加し、双方向整合性を管理。
- `importTodoMd`/`exportTodoMd` で `Related:` ブロックと DB を同期。
- MCP API: `get_task` に `links` 配列、`add_link`/`remove_link` または `patch_task.links` を実装。

## 4. Notes ブロック（コメントメモ）
- `Notes:` 直下を `<details>` もしくはインデント付き箇条書きでコメント履歴を記録。
- `task_notes` テーブル（`id`, `task_id`, `at`, `author`, `body`, `is_internal`）を追加。
- `get_task` に `notes` を返し、`post_note`/`delete_note`/`update_note` API を検討。
- `exportTodoMd`/`importTodoMd` で `Notes:` と DB の往復を保証。

## 5. 差分更新 API `patch_task`
- JSON-RPC メソッド `patch_task` を追加し `set`/`append`/`merge`/`delete`/`replace` 等の差分操作を受け付ける。
- `if_vclock` を確認し競合時は `409 vclock_conflict`。成功時は新しい `vclock` を返す。
- DB では `patchTask` を実装し、対象フィールドのみ更新。`meta.merge` で JSON マージ。
- クライアントは小刻みな更新、Undo/Redo を効率的に送信可能。

## 6. 変更購読 API `watch_tasks`
- `watch_tasks` でイベント購読を開始し、`task_event` 通知を WebSocket で push。
- フィルタ（`ids`, `event_types`, `include_archived`）と `since_vclock` をサポート。
- `unwatch_tasks` で購読解除。再接続時は `since_vclock` でバックフィル。
- クライアントはリアルタイム更新・差分同期・通知機能を実装しやすくなる。

## 7. 検索ハイライト強化
- `search` API に `tags`, `priority`, `state`, `include_archived` などのフィルタを追加。`tag:foo` などをパーサで処理。
- TODO.md の節構造をスコアリングに反映し、`section` 情報を結果に含める。
- `highlight` に加え、`matched_tags` や節タイトルスニペットを返す。
- タグ専用テーブル（`task_tags`）や `bm25` のウェイト調整を活用。

## 8. 添付ファイルメタ情報
- `task_blobs` に `filename`, `mime_type`, `size`, `created_at` を追加。
- `attach_blob` に `filename`/`mime_type`、`get_task`/`get_blob` にメタ情報を含める。
- TODO.md に `Attachments:` ブロックを導入（例: `[file](blob://sha256/...) (mime, size)`）。
- クライアントはプレビューや種類別フィルタを実装可能。

## 9. ローカル ID と正式 ID の併用
- `Meta.local_id` を導入し、TODO.md 見出しではローカル ID が使用可能。
- `tasks.local_id` カラムを追加し、`upsert_task`/`patch_task` で `local_id` を受け付ける。
- 同期時に正式 ID を割り当て、エクスポートで見出しを正式 ID に置換（`Meta.local_id` を維持可能）。

## 10. エラーレスポンス拡張
- JSON-RPC エラーに `details`, `hint`, `doc_url` を追加して返す。
- 例: `vclock_conflict` で `details.current_vclock`, `hint` に再同期手順。 
- クライアントは詳細情報を UI で提示し、衝突解消を誘導できる。
